<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🧪 晶圓覆蓋率模擬器｜含損壞晶片</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body{font-family:'Microsoft JhengHei',sans-serif;background:#fffaf6;color:#4e342e;margin:0;padding:0}
    *{box-sizing:border-box;}input,select,textarea{max-width:100%;}
    header{text-align:center;padding:20px}
    h1{color:#ff7043}
    .wrap{width:min(1100px,95vw);margin:0 auto;display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:1200px){.wrap{grid-template-columns:400px 1fr}}
    .card{background:#fff;border:1px solid #f3d8c8;border-radius:12px;padding:16px;box-shadow:0 5px 15px rgba(255,112,67,.15)}
    label{font-weight:bold;display:block;margin-bottom:6px}
    input[type=range]{width:100%}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px}
    .kpi .box{border:1px dashed #f3b9a0;border-radius:8px;padding:8px;background:#fffdfb}
    .kpi .val{font-size:1.5em;font-weight:bold;color:#43a047}
    canvas{width:100%;height:auto;border:1px solid #f3d8c8;border-radius:10px;margin-top:10px;background:#fff}
  </style>
</head>
<body>
  <body>
  <script>
    var password = "9527"; // 在這裡設定你的密碼
    var passwordInput = prompt("請輸入密碼以存取此頁面：");

    if (passwordInput === password) {
        // 如果密碼正確，顯示頁面內容
        document.body.style.display = "block";
    } else {
        // 如果密碼錯誤，隱藏頁面或導向錯誤頁面
        alert("密碼錯誤，無法存取。");
        window.location.href = "about:blank"; // 導向空白頁面
    }
</script>

<style>
    body {
        display: none; /* 預設先隱藏頁面內容 */
    }
</style>
<header>
  <h1><i class="bi bi-cpu"></i> 晶圓覆蓋率模擬器 ✨</h1>
  <p>晶圓大小會依照 12 吋基準縮小顯示，並可模擬損壞晶片</p>
</header>
<main class="wrap">
  <section class="card">
    <label for="edge">邊緣排除： <span id="edgeLabel">1 mm</span></label>
    <input type="range" id="edge" min="0" max="5" step="1" value="1">

    <label for="kerf">切割道寬： <span id="kerfLabel">0.5 mm</span></label>
    <input type="range" id="kerf" min="0" max="4" step="1" value="1">

    <label for="dieSize">晶片邊長： <span id="dieLabel">30 mm</span></label>
    <input type="range" id="dieSize" min="0" max="4" step="1" value="4">

    <label for="wafer">晶圓直徑： <span id="waferLabel">6吋 (150 mm)</span></label>
    <input type="range" id="wafer" min="0" max="2" step="1" value="0">

    <label for="badChips">損壞晶片數： <span id="badLabel">0</span></label>
    <input type="range" id="badChips" min="0" max="20" step="1" value="0">
  </section>
  <section class="card">
    <div class="kpi">
      <div class="box"><div>晶片數</div><div id="diesGrid" class="val">—</div></div>
      <div class="box"><div>損壞晶片數</div><div id="badCount" class="val">—</div></div>
      <div class="box"><div>良率</div><div id="yieldRate" class="val">—</div></div>
      <div class="box"><div>覆蓋率</div><div id="coverageRate" class="val">—</div></div>
      <div class="box"><div>浪費率</div><div id="wasteRate" class="val">—</div></div>
    </div>
    <canvas id="waferCanvas" width="600" height="600"></canvas>
  </section>
</main>
<script>
const $=id=>document.getElementById(id);
const canvas=$("waferCanvas"),ctx=canvas.getContext("2d");

// 基準設定：12吋 = 300 mm
const baseWafer=300;

const waferOptions=[150,200,300]; // mm (6吋, 8吋, 12吋)
const waferLabels=["6吋 (150 mm)","8吋 (200 mm)","12吋 (300 mm)"];
const kerfOptions=[0,0.5,1,1.5,2];
const dieOptions=[7,11,15,23,30]; // 晶片邊長

let diePositions=[]; // 儲存每個晶片的座標，用來標記損壞

// 更新 label
$("wafer").addEventListener("input",()=>{$("waferLabel").textContent=waferLabels[$("wafer").value];simulate();});
$("edge").addEventListener("input",()=>{$("edgeLabel").textContent=$("edge").value+" mm";simulate();});
$("kerf").addEventListener("input",()=>{$("kerfLabel").textContent=kerfOptions[$("kerf").value]+" mm";simulate();});
$("dieSize").addEventListener("input",()=>{$("dieLabel").textContent=dieOptions[$("dieSize").value]+" mm";simulate();});
$("badChips").addEventListener("input",()=>{$("badLabel").textContent=$("badChips").value;simulate();});

function computeScale(){return (canvas.width-40)/baseWafer;} // 永遠以12吋基準縮放

function drawWafer(D,edge){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const scale=computeScale(),c=canvas.width/2;
  const R=(D/2)*scale,Reff=(D/2-edge)*scale;
  ctx.fillStyle="#ffe9df";ctx.beginPath();ctx.arc(c,c,R,0,2*Math.PI);ctx.fill();
  ctx.fillStyle="#ffd0bf";ctx.beginPath();ctx.arc(c,c,Reff,0,2*Math.PI);ctx.fill();
  return{c,scale,Reff}
}

function rectInCircle(cx,cy,r,x,y,w,h){
  return [[x,y],[x+w,y],[x,y+h],[x+w,y+h]].every(([px,py])=> (px-cx)**2+(py-cy)**2<=r**2);
}

function simulate(){
  const D=waferOptions[Number($("wafer").value)];
  const edge=Number($("edge").value);
  const kerf=kerfOptions[Number($("kerf").value)];
  const dieLen=dieOptions[Number($("dieSize").value)];
  const badInput=Number($("badChips").value);

  const {c,scale,Reff}=drawWafer(D,edge);

  const step=(dieLen+kerf),effR=(D/2-edge),waferArea=Math.PI*effR**2,dieA=dieLen**2;
  let count=0;
  diePositions=[];
  ctx.strokeStyle="#ff7043";ctx.fillStyle="rgba(255,112,67,.6)";
  
  const maxSteps=Math.floor(effR/step);
  for(let iy=-maxSteps;iy<=maxSteps;iy++){
    for(let ix=-maxSteps;ix<=maxSteps;ix++){
      const x=ix*step,y=iy*step;
      if(rectInCircle(0,0,Reff,x*scale,y*scale,dieLen*scale,dieLen*scale)){
        ctx.fillRect(c+x*scale,c+y*scale,dieLen*scale,dieLen*scale);
        diePositions.push({x:c+x*scale,y:c+y*scale,size:dieLen*scale});
        count++;
      }
    }
  }

  // 限制損壞晶片數 <= 晶片數
  const badCount=Math.min(badInput,count);
  $("badChips").max=count; // 動態調整上限
  $("badLabel").textContent=badCount;

  // 隨機挑選壞晶片
  let chosen=new Set();
  while(chosen.size<badCount){
    chosen.add(Math.floor(Math.random()*diePositions.length));
  }
  ctx.strokeStyle="red";ctx.lineWidth=2;
  for(let idx of chosen){
    let d=diePositions[idx];
    ctx.beginPath();
    ctx.moveTo(d.x,d.y);
    ctx.lineTo(d.x+d.size,d.y+d.size);
    ctx.moveTo(d.x+d.size,d.y);
    ctx.lineTo(d.x,d.y+d.size);
    ctx.stroke();
  }

  $("diesGrid").textContent=count;
  $("badCount").textContent=badCount;
  $("yieldRate").textContent=(count>0?((count-badCount)/count*100).toFixed(2):0)+"%";
  const coverage=(count*dieA/waferArea);
  $("coverageRate").textContent=(coverage*100).toFixed(2)+"%";
  $("wasteRate").textContent=((1-coverage)*100).toFixed(2)+"%";
}
window.onload=simulate;
</script>
</body>
</html>
